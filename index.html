<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æˆ‘è¿˜æ´»ç€ - ç¦»çº¿å­˜æ´»ç¡®è®¤</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="manifest" href="manifest.json">
    <link rel="icon" href="icons/icon-192.png">
    <meta name="theme-color" content="#2c3e50">
</head>

<body>
    <div id="app">
        <header>
            <h1>æˆ‘è¿˜æ´»ç€</h1>
            <div class="header-actions">
                <button id="btn-theme-toggle" class="icon-btn" title="åˆ‡æ¢ä¸»é¢˜">ğŸŒ“</button>
                <button id="btn-settings-toggle" class="icon-btn" title="è®¾ç½®">âš™ï¸</button>
            </div>
        </header>

        <main id="view-container">
            <!-- è§†å›¾å°†é€šè¿‡ JS æ¸²æŸ“ -->
        </main>
    </div>

    <!-- æ ¸å¿ƒè„šæœ¬ -->
    <script src="js/storage.js"></script>
    <script src="js/mail.js"></script>
    <script src="js/auth.js"></script>
    <script>
        const state = {
            user: Auth.getUser(),
            config: Storage.load(Storage.KEYS.CONFIG) || {},
            lastCheckIn: Storage.load(Storage.KEYS.LAST_CHECK_IN) || null,
            records: Storage.load(Storage.KEYS.RECORDS) || [],
            currentView: 'auth'
        };

        const DOM = {
            container: document.getElementById('view-container'),
            settingsToggle: document.getElementById('btn-settings-toggle')
        };

        function init() {
            // åˆå§‹åŒ–ä¸»é¢˜
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.documentElement.setAttribute('data-theme', savedTheme);

            if (!Auth.isLoggedIn()) {
                switchView('auth');
            } else {
                switchView('active');
            }

            render(); // å…³é”®ä¿®å¤ï¼šåˆå§‹æ¸²æŸ“

            document.getElementById('btn-theme-toggle').onclick = () => {
                const current = document.documentElement.getAttribute('data-theme');
                const next = current === 'light' ? 'dark' : 'light';
                document.documentElement.setAttribute('data-theme', next);
                localStorage.setItem('theme', next);
            };

            DOM.settingsToggle.onclick = () => {
                if (state.currentView === 'settings') {
                    if (!Auth.isLoggedIn()) return switchView('auth');
                    switchView('active');
                } else {
                    switchView('settings');
                }
            };
        }

        init(); // è°ƒç”¨åˆå§‹åŒ–

        function switchView(viewName) {
            // å¼ºåˆ¶è·³è½¬é€»è¾‘ï¼šæœªç™»å½•ä¸èƒ½è¿› active
            if (!Auth.isLoggedIn() && viewName === 'active') {
                viewName = 'auth';
            }
            state.currentView = viewName;
            render();
        }

        function render() {
            DOM.container.innerHTML = '';

            if (state.currentView === 'auth') {
                renderAuth();
            } else if (state.currentView === 'settings') {
                renderSettings();
            } else if (state.currentView === 'active') {
                renderActiveView();
            }
        }

        function renderAuth() {
            DOM.container.innerHTML = `
                <div class="view auth-view">
                    <div class="tabs">
                        <button class="tab-btn active" onclick="showAuthTab('login')">ç™»å½•</button>
                        <button class="tab-btn" onclick="showAuthTab('register')">æ³¨å†Œ</button>
                    </div>
                    
                    <div id="login-form" class="auth-form">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="auth-username" placeholder="è¾“å…¥æ‚¨çš„è´¦å·å">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" id="auth-password" placeholder="è¾“å…¥æ‚¨çš„å¯†ç ">
                        </div>
                        <button class="btn btn-primary" onclick="handleLogin()">ç«‹å³ç™»å½•</button>
                    </div>

                    <div id="register-form" class="auth-form" style="display:none">
                        <div class="form-group">
                            <label>ç”¨æˆ·å</label>
                            <input type="text" id="reg-username" placeholder="å»ºè®®ä½¿ç”¨é‚®ç®±å">
                        </div>
                        <div class="form-group">
                            <label>æ˜µç§°</label>
                            <input type="text" id="reg-nickname" placeholder="è®©å¯¹æ–¹çŸ¥é“æ‚¨æ˜¯è°">
                        </div>
                        <div class="form-group">
                            <label>å¯†ç </label>
                            <input type="password" id="reg-password" placeholder="å»ºè®®ä½¿ç”¨ 8 ä½ä»¥ä¸Šå­—ç¬¦">
                        </div>
                        <div class="form-group">
                            <label>é‚€è¯·ç </label>
                            <input type="text" id="reg-invite" placeholder="å¿…å¡«ï¼Œè¯·å‘ç®¡ç†å‘˜è·å–">
                        </div>
                        <div class="form-group">
                            <label>æˆ‘çš„èº«ä»½</label>
                            <select id="reg-role">
                                <option value="sender">ä½¿ç”¨è€…</option>
                                <option value="guardian">ç›‘æŠ¤äºº</option>
                            </select>
                        </div>
                        <button class="btn btn-primary" onclick="handleRegister()">å®Œæˆæ³¨å†Œ</button>
                    </div>
                </div>
            `;
        }

        function showAuthTab(tab) {
            document.getElementById('login-form').style.display = tab === 'login' ? 'block' : 'none';
            document.getElementById('register-form').style.display = tab === 'register' ? 'block' : 'none';
            document.querySelectorAll('.tab-btn').forEach((btn, i) => {
                btn.classList.toggle('active', (tab === 'login' && i === 0) || (tab === 'register' && i === 1));
            });
        }

        async function handleLogin() {
            const u = document.getElementById('auth-username').value.trim();
            const p = document.getElementById('auth-password').value.trim();
            if (!u || !p) return alert('è¯·å¡«å…¥è´¦å·å’Œå¯†ç ');

            try {
                await Auth.login(u, p);
                state.user = Auth.getUser();
                location.reload(); // ç™»å½•ååˆ·æ–°çŠ¶æ€
            } catch (err) {
                alert('ç™»å½•å¤±è´¥: ' + err.message);
            }
        }

        async function handleRegister() {
            const u = document.getElementById('reg-username').value.trim();
            const n = document.getElementById('reg-nickname').value.trim();
            const p = document.getElementById('reg-password').value.trim();
            const i = document.getElementById('reg-invite').value.trim();
            const r = document.getElementById('reg-role').value;

            if (!u || !p || !n) return alert('è¯·å®Œå–„æ³¨å†Œä¿¡æ¯ï¼ˆè´¦å·ã€æ˜µç§°ã€å¯†ç ï¼‰');

            try {
                await Auth.register(u, p, i, r, n);
                alert('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•');
                showAuthTab('login');
            } catch (err) {
                alert('æ³¨å†Œå¤±è´¥: ' + err.message);
            }
        }

        function renderSettings() {
            const user = Auth.getUser();
            DOM.container.innerHTML = `
                <div class="view settings-view">
                    <div class="settings-header">
                        <h2>ä¸ªäººè®¾ç½®</h2>
                        <span class="user-id">æˆ‘çš„: <b>${user ? user.nickname : 'æœªç™»å½•'}</b> (<code>${user ? user.id.substring(0, 8) : '...'}</code>)</span>
                    </div>
                    
                    <div id="config-fields"></div>

                    ${user ? `
                    <div class="binding-section">
                        <h3>ç»‘å®šç®¡ç†</h3>
                        <div id="binding-info">åŠ è½½ä¸­...</div>
                    </div>

                    <div class="actions">
                        <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                        <button class="btn btn-secondary" onclick="Auth.logout()">é€€å‡ºç™»å½•</button>
                        <button class="btn btn-danger" onclick="clearRecords()">æ¸…ç©ºå†å²æ•°æ®</button>
                    </div>
                    ` : `
                    <div class="info-section">
                        <p class="small">æ‚¨å°šæœªç™»å½•ã€‚ä»¥ä¸Šéƒ¨åˆ†è®¾ç½®ç”Ÿæ•ˆéœ€å…ˆå®Œæˆç™»å½•ã€‚</p>
                        <div class="actions">
                            <button class="btn btn-primary" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                            <button class="btn btn-secondary" onclick="switchView('auth')">è¿”å›ç™»å½•</button>
                        </div>
                    </div>
                    `}
                </div>
            `;
            renderConfigFields();
            renderBindingPanel();
        }


        function renderConfigFields() {
            DOM.configFields = document.getElementById('config-fields');
            let html = `
                <div class="form-group">
                    <label>æ¡¥æ¥/API æ¥å£ URL</label>
                    <input type="url" id="field-bridge" value="${state.config.bridgeUrl || ''}" placeholder="é»˜è®¤: https://alive-bridge.alunnb.workers.dev">
                </div>
            `;
            // ä»¥åè¿™é‡Œå¯ä»¥ä¿ç•™åŸæœ‰é‚®ç®±é…ç½®ä½œä¸ºå¤‡é€‰ï¼Œä½†ç›®å‰ä¼˜å…ˆä½¿ç”¨ API æ¨¡å¼
            DOM.configFields.innerHTML = html;
        }

        async function renderBindingPanel() {
            const panel = document.getElementById('binding-info');
            const user = Auth.getUser();

            if (user.role === 'sender') {
                panel.innerHTML = `
                    <div class="form-group">
                        <label>å‘èµ·ç»‘å®š (è¾“å…¥ä¸»äººçš„ ID)</label>
                        <input type="text" id="bind-target-id" placeholder="ä¾‹å¦‚: 550e8400-e29b-41d4-a716-446655440000">
                        <button class="btn btn-secondary btn-small" onclick="requestBinding()">å‘é€ç»‘å®šè¯·æ±‚</button>
                    </div>
                `;
            } else {
                try {
                    const requests = await Auth.getPending();
                    if (requests.length === 0) {
                        panel.innerHTML = `<p class="small">æš‚æ— å¾…å¤„ç†çš„ç»‘å®šè¯·æ±‚</p>`;
                    } else {
                        panel.innerHTML = requests.map(req => `
                            <div class="request-item">
                                <span class="small">ç”¨æˆ·: <b>${req.nickname || 'åŒ¿å'}</b> (<code>${req.from.substring(0, 8)}</code>) è¯·æ±‚ç»‘å®š</span>
                                <div class="action-btns">
                                    <button class="btn-text btn-safe" onclick="handleConfirmBind('${req.from}', 'accept')">å‡†è®¸</button>
                                    <button class="btn-text btn-danger" onclick="handleConfirmBind('${req.from}', 'reject')">æ‹’ç»</button>
                                </div>
                            </div>
                        `).join('');
                    }
                } catch (err) {
                    panel.innerHTML = `<p class="small error">è·å–è¯·æ±‚å¤±è´¥: ${err.message}</p>`;
                }
            }
        }

        async function handleConfirmBind(sourceId, action) {
            try {
                await Auth.confirmBind(sourceId, action);
                alert(action === 'accept' ? 'å·²æ¥å—ç»‘å®š' : 'å·²æ‹’ç»');
                renderBindingPanel();
            } catch (err) {
                alert('æ“ä½œå¤±è´¥: ' + err.message);
            }
        }

        async function requestBinding() {
            const id = document.getElementById('bind-target-id').value.trim();
            if (!id) return alert('è¯·è¾“å…¥ç›®æ ‡ ID');
            try {
                await Auth.reqBind(id);
                alert('è¯·æ±‚å·²å‘é€ï¼Œè¯·è”ç³»å¯¹æ–¹åœ¨è®¾ç½®ä¸­ç¡®è®¤ã€‚');
            } catch (err) {
                alert('å‘é€å¤±è´¥: ' + err.message);
            }
        }

        function onEmailInput(el) {
            if (state.user?.role === 'sender') {
                const host = Mailer.getSmtpHost(el.value);
                const smtpEl = document.getElementById('field-smtp');
                if (smtpEl && host) smtpEl.value = host;
            }
        }

        function saveSettings() {
            const bridgeEl = document.getElementById('field-bridge');
            const bridgeUrl = bridgeEl ? bridgeEl.value.trim() : '';

            if (!bridgeUrl) return alert('è¯·é…ç½®æ¡¥æ¥ URL (API æ¥å£)');

            const config = { bridgeUrl };
            state.config = config;
            Storage.save(Storage.KEYS.CONFIG, config);

            alert('è®¾ç½®å·²ä¿å­˜');

            if (Auth.isLoggedIn()) {
                renderActiveView();
                switchView('active');
            } else {
                switchView('auth');
            }
        }

        function clearRecords() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å†å²è®°å½•å—ï¼Ÿ')) {
                state.records = [];
                Storage.save(Storage.KEYS.RECORDS, []);
                renderActiveView();
            }
        }

        async function handleCheckIn() {
            const btn = document.getElementById('btn-check-in');
            btn.disabled = true;
            btn.innerText = 'æ­£åœ¨å‘é€...';

            try {
                await Auth.sendPulse();
                state.lastCheckIn = new Date().toISOString();
                Storage.save(Storage.KEYS.LAST_CHECK_IN, state.lastCheckIn);
                renderActiveView();
                alert('ç­¾åˆ°æˆåŠŸ');
            } catch (err) {
                console.error(err);
                alert('ç­¾åˆ°å¤±è´¥: ' + err.message);
            } finally {
                btn.disabled = false;
                btn.innerText = 'ç«‹å³ç­¾åˆ°';
            }
        }

        function renderActiveView() {
            if (state.user?.role === 'sender') {
                renderSenderView();
            } else {
                renderGuardianView();
            }
        }

        function renderSenderView() {
            const lastTime = state.lastCheckIn ? new Date(state.lastCheckIn).toLocaleString() : 'ä»æ— ';
            DOM.container.innerHTML = `
                <div class="view active-view">
                    <div class="status-card">
                        <div class="status-icon">âœ…</div>
                        <div class="status-info">
                            <p>çŠ¶æ€ï¼šå½“å‰å®‰å…¨</p>
                            <p class="small">ä¸Šæ¬¡ç­¾åˆ°ï¼š${lastTime}</p>
                        </div>
                    </div>
                    <button id="btn-check-in" class="btn btn-primary btn-large" onclick="handleCheckIn()">ç«‹å³ç­¾åˆ°</button>
                    <div class="info-section">
                        <p>è¯·ä¿æŒæ¯å¤©è‡³å°‘ç­¾åˆ°ä¸€æ¬¡ã€‚å¦‚æœè¶…è¿‡ 48 å°æ—¶æœªæ”¶åˆ°æ‚¨çš„ç­¾åˆ°é‚®ä»¶ï¼Œç›‘æŠ¤ç«¯å°†æ”¶åˆ°æé†’ã€‚</p>
                    </div>
                </div>
            `;
        }

        async function renderGuardianView() {
            DOM.container.innerHTML = `
                <div class="view active-view">
                    <div class="guardian-header">
                        <h2>æˆ‘çš„ç›‘æŠ¤åˆ—è¡¨</h2>
                        <button class="btn btn-secondary btn-small" onclick="checkGuardianStatus()">æ‰‹åŠ¨åˆ·æ–°</button>
                    </div>
                    <div id="guardian-list" class="guardian-list">
                        <p class="small">æ­£åœ¨æ£€æŸ¥è¿æ¥çŠ¶æ€...</p>
                    </div>
                </div>
            `;
            checkGuardianStatus();
        }

        async function checkGuardianStatus() {
            const list = document.getElementById('guardian-list');

            try {
                const results = await Auth.getStatus(); // è¿”å› [{id, date}]
                if (results.length === 0) {
                    list.innerHTML = `<p class="small">æš‚æ— ç»‘å®šçš„ä½¿ç”¨è€…ã€‚è¯·å°†æ‚¨çš„ ID å‘ç»™å¯¹æ–¹è¿›è¡Œç»‘å®šç”³è¯·ã€‚</p>`;
                    return;
                }

                list.innerHTML = results.map(r => {
                    const last = r.date ? new Date(r.date) : null;
                    const hours = last ? (new Date() - last) / (1000 * 60 * 60) : Infinity;
                    const isWarning = hours > 48;
                    const statusClass = isWarning ? 'status-danger' : 'status-safe';

                    return `
                        <div class="status-card ${statusClass}">
                            <div class="status-icon">${isWarning ? 'âš ï¸' : 'âœ…'}</div>
                            <div class="status-info">
                                <div class="status-name-row">
                                    <p class="nickname"><b>${r.remark || r.nickname || 'æœªå‘½å'}</b> (<code>${r.id.substring(0, 8)}</code>)</p>
                                    <button class="btn-icon-tiny" onclick="editRemark('${r.id}', '${r.remark || r.nickname || ''}')">âœï¸</button>
                                </div>
                                <p class="small">æœ€åç­¾åˆ°: ${last ? last.toLocaleString() : 'ä»æ— '}</p>
                                <p class="small status-msg">${isWarning ? 'ç¦»çº¿é¢„è­¦' : 'çŠ¶æ€å®‰å…¨'}</p>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (err) {
                list.innerHTML = `<p class="small error">è·å–å¤±è´¥: ${err.message}</p>`;
            }
        }

        async function editRemark(id, current) {
            const remark = prompt('ä¸ºè¯¥ç”¨æˆ·è®¾ç½®å¤‡æ³¨å:', current);
            if (remark === null) return;
            try {
                await Auth.setRemark(id, remark);
                checkGuardianStatus();
            } catch (err) {
                alert('è®¾ç½®å¤‡æ³¨å¤±è´¥: ' + err.message);
            }
        }

        // åˆå§‹åŒ–
        init();
    </script>
</body>

</html>